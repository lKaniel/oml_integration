# OML-LightboxTV Integration Service

## Дипломна робота
**Тема:** ІНТЕГРАЦІЯ МЕДІА ПЛАТФОРМ  
**Виконав:** Шевчук Віталій Ігорович  
**Науковий керівник:** Панченко Тарас Володимирович

## Опис

Інтеграційний сервіс між платформою управління рекламними кампаніями Open Media Logic (OML) та потоковою платформою LightboxTV. Сервіс забезпечує єдину екосистему управління рекламними кампаніями як на традиційному лінійному телебаченні, так і на сучасних потокових сервісах.

## Структура проекту

```
src/
  ├── app.module.ts         # Головний модуль додатку
  ├── main.ts               # Вхідна точка додатку
  ├── index.ts              # Експорти для публічного API
  └── modules/
      └── lightbox/
          ├── integration.controller.ts  # Контролер API
          ├── integration.module.ts      # Визначення модуля
          └── services/
              └── integration.service.ts # Основна бізнес-логіка
```

## Встановлення

```bash
# Встановлення залежностей
pnpm install

# Збірка проекту
pnpm build
```

## Запуск сервісу

```bash
# Режим розробки
pnpm start:dev

# Виробничий режим
pnpm start:prod
```

## Тестування API

Для перевірки роботи API можна використати тестовий скрипт:

```bash
# Запустити сервер
pnpm start:dev

# В іншому терміналі запустити тестовий скрипт
node test-api.js
```

## API Endpoints

### POST /lightbox/publish-campaign

Публікує рекламну кампанію з LightboxTV у систему OML.

#### Структура запиту

```json
{
  "campaign": {
    "id": 12345,
    "name": "Summer Campaign 2025",
    "start_date": "2025-04-24",
    "end_date": "2025-04-30",
    "budget": 1000000,
    "advertiser_id": 101,
    "status": "draft",
    "creative_ids": [201, 202],
    "placements": [
      {
        "id": 1001,
        "campaign_id": 12345,
        "channel_id": 9,
        "brand_id": 401,
        "target_audience_id": 501,
        "start_date": "2025-04-24",
        "end_date": "2025-04-30",
        "budget": 350000,
        "priority": 1,
        "creative_ids": [201]
      }
    ]
  },
  "creatives": [
    {
      "id": 201,
      "name": "Summer Promo 30s",
      "duration": 30,
      "file_url": "https://storage.lightboxtv.com/creatives/summer_promo_30s.mp4",
      "format": "mp4",
      "advertiser_id": 101,
      "brand_id": 401
    }
  ],
  "config": {
    "omlBaseUrl": "https://ge-api.omldev.org",
    "omlUsername": "username",
    "omlPassword": "password",
    "yearId": 2025,
    "defaultPlacementTypeId": 1,
    "defaultCommercialTypeId": 1,
    "defaultCommercialVersionTypeId": 1,
    "maxRetries": 3
  }
}
```

#### Структура відповіді

```json
{
  "success": true,
  "status": "complete",
  "commercial_ids": [123, 456],
  "spot_ids": [789, 101],
  "details": "Інтеграція кампанії успішно завершена"
}
```

## Обробка помилок

Якщо під час інтеграції виникає помилка, API повертає детальну інформацію про помилку:

```json
{
  "success": false,
  "status": "failed",
  "error": "Текст помилки",
  "details": "Детальна інформація про помилку, включаючи етапи, які були виконані до виникнення помилки"
}
```

## Особливості реалізації

Інтеграційний сервіс забезпечує:

1. **Аутентифікацію в OML** - безпечне підключення до API OML з використанням JWT токенів
2. **Синхронізацію довідників** - синхронізація даних про рекламодавців, бренди, канали та цільові аудиторії
3. **Підготовку креативів** - пошук та мапінг комерційних матеріалів
4. **Бронювання спотів** - резервування рекламних місць в системі OML
5. **Моніторинг прогресу** - детальне логування всіх етапів інтеграції

### Механізми забезпечення надійності

- **Ідемпотентність операцій** - запобігання дублюванню даних при повторних спробах
- **Асинхронна обробка** - ефективна робота з великими обсягами даних
- **Повторні спроби** - автоматичні повторні спроби у разі тимчасових помилок
- **Детальне логування** - відстеження всіх етапів інтеграції для аналізу та діагностики

## Розробка

### Додавання нових функцій

Для додавання нових функцій або модифікації існуючих:

1. Основна бізнес-логіка знаходиться в `src/modules/lightbox/services/integration.service.ts`
2. API ендпоінти визначені в `src/modules/lightbox/integration.controller.ts`
3. Після внесення змін зберіть та протестуйте додаток

### Змінні оточення

Для розгортання у виробничому середовищі рекомендується використовувати змінні оточення для конфіденційної інформації:

- URL API OML
- Облікові дані OML
- Інші конфігураційні параметри

## Ліцензія

ISC License
